CAN controller with state machine
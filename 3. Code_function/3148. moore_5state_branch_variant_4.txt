Branching state machine with outputs
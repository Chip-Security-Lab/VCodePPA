Pipelined state machine with gating